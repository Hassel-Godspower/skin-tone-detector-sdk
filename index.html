<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skin Tone Detector Demo</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      background: #fafafa;
      color: #333;
      margin: 0;
      padding: 20px;
    }

    h1 {
      margin-bottom: 12px;
    }

    video, img, canvas {
      border-radius: 12px;
      background: #000;
      max-width: 90%;
    }

    #container {
      position: relative;
      display: inline-block;
      margin-top: 10px;
    }

    #samplingCircle {
      position: absolute;
      border: 2px solid #00bcd4;
      border-radius: 50%;
      cursor: move;
      resize: both;
      overflow: hidden;
      width: 200px;
      height: 200px;
      top: 50px;
      left: 50px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      user-select: none;
    }

    #controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button, input[type="file"] {
      background: #00bcd4;
      border: none;
      padding: 10px 18px;
      color: white;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #0097a7;
    }

    input[type="file"] {
      background: #607d8b;
    }

    #result {
      margin-top: 18px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h1>Skin Tone Detector</h1>
  <div id="container">
    <video id="video" autoplay playsinline width="480" height="360"></video>
    <img id="uploadedImage" style="display:none;" width="480" height="360" />
    <canvas id="canvas" width="480" height="360" style="display:none;"></canvas>
    <div id="samplingCircle"></div>
  </div>

  <div id="controls">
    <button id="startCamera">Start Camera</button>
    <input type="file" id="uploadImage" accept="image/*">
    <button id="detectTone">Detect Tone</button>
  </div>

  <div id="result"></div>

  <script type="module">
    import { analyzeSkinColor } from "./index.js";

    const video = document.getElementById("video");
    const uploadedImage = document.getElementById("uploadedImage");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const result = document.getElementById("result");
    const circle = document.getElementById("samplingCircle");

    let isDragging = false;
    let offsetX, offsetY;
    let usingCamera = true;

    // --- Camera Access ---
    document.getElementById("startCamera").addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        uploadedImage.style.display = "none";
        video.style.display = "block";
        usingCamera = true;
      } catch (err) {
        alert("Camera access denied or not available.");
      }
    });

    // --- Image Upload ---
    document.getElementById("uploadImage").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          uploadedImage.src = e.target.result;
          uploadedImage.style.display = "block";
          video.style.display = "none";
          usingCamera = false;
        };
        reader.readAsDataURL(file);
      }
    });

    // --- Drag Circle ---
    circle.addEventListener("mousedown", (e) => {
      isDragging = true;
      offsetX = e.clientX - circle.offsetLeft;
      offsetY = e.clientY - circle.offsetTop;
    });

    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      circle.style.left = e.clientX - offsetX + "px";
      circle.style.top = e.clientY - offsetY + "px";
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
    });

    // --- Detect Tone ---
    document.getElementById("detectTone").addEventListener("click", () => {
      if (usingCamera) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.drawImage(uploadedImage, 0, 0, canvas.width, canvas.height);
      }

      const circleRect = circle.getBoundingClientRect();
      const frameRect = usingCamera ? video.getBoundingClientRect() : uploadedImage.getBoundingClientRect();

      const x = circleRect.left - frameRect.left;
      const y = circleRect.top - frameRect.top;
      const w = circleRect.width;
      const h = circleRect.height;

      const imageData = ctx.getImageData(x, y, w, h);
      const data = imageData.data;

      let r = 0, g = 0, b = 0, count = 0;
      for (let i = 0; i < data.length; i += 4) {
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
        count++;
      }

      r = Math.round(r / count);
      g = Math.round(g / count);
      b = Math.round(b / count);

      const tone = analyzeSkinColor({ r, g, b });
      const hex = `#${((1 << 24) + (r << 16) + (g << 8) + b)
        .toString(16)
        .slice(1)
        .toUpperCase()}`;

      result.innerHTML = `
        <b>Detected Color:</b> rgb(${r}, ${g}, ${b}) <br>
        <b>HEX:</b> ${hex} <br>
        <b>Closest Tone:</b> ${tone.name}
      `;
    });
  </script>
</body>
</html>
